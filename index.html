<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>WebFlood</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="main.css">

		<script src="deps/underscore-min.js"></script>
		<script src="deps/GLOW.js"></script>
		<script src="lib/helpers.js"></script>

		<script src="deps/perlin.js"></script>
		<script src="lib/terrainGenerator.js"></script>
		<script src="deps/tiff.js"></script>
		<script src="lib/write16bitTiff.js"></script>

		<script src="lib/tiledGrid.js"></script>
		<script src="lib/flipFlopFBO.js"></script>
		<script src="lib/camera.js"></script>
	</head>
	<body>
		<div id="container"></div>
		<p>
			<span id="load">
				<br>
				Load scenario:<br><input type="file" id="files" name="files[]" multiple /><br><br>
				<a id="newTerrain" href="">Random Scenario</a> -
				Resolution: <select id="resolution">
					<option value="128">128*128</option>
					<option value="256" selected>256*256</option>
					<option value="512">512*512</option>
					<option value="1024">1024*1024 (unstable)</option>
				</select> <br><br>
			</span>
			<span id="run">
				<input type="text" id="scenarioName" value="no scenario loaded..."><br>
				<button id="saveWater">Save Water Height</button>
				<button id="saveTerrain">Save Terrain</button><br><br>
				<a id="closeScenario" href="index.html">Close Scenario</a><br><br>

				Frame duration: <span id="frameDuration">???</span><br>
				Simulation Steps <input type="number" value="0" id="stepsPerFrame"> per frame<br><br>

				Source Water Height: <input id="sourceWaterHeight" type="number" value="0.0024" step="0.005"/><br>
				Source Water Velocity: <input id="sourceWaterVelocity" type="number" value="0.00001" step="0.0005"/><br>
				Gravity: <input id="gravity" type="number" value="9.81" step="0.001"/><br><br>

				<em>Friction</em> -
				Manning coefficient: <input id="manningCoefficient" type="number" value="0.070" step="0.001"/><br><br>
				Drainage: <input id="drainageAmount" type="number" value="0" step="0.00001"/><br><br>

				<input type="checkbox" checked id="showWater"><label for="showWater">Display Water</label><br>
				<input type="checkbox" id="showFloodDuration"><label for="showFloodDuration">Display Flood Duration</label><br>
				<input type="checkbox" id="showMaxVelocity"><label for="showMaxVelocity">Display Max Velocity</label><br>
				<input type="checkbox" id="showMaxDepth"><label for="showMaxDepth">Display Max Depth</label><br><br>
			</span>
		</p>

		<script src="ui.js"></script>
		<script src="simulation.js"></script>
		<script src="visualisation.js"></script>

		<script>
			var devicePixelRatio = 1.0;// || window.devicePixelRatio || 1;
			var context = new GLOW.Context({
				clear: {red: 1, green: 1, blue: 1},
				preserveDrawingBuffer: true,
				width: window.innerWidth * devicePixelRatio,
				height: window.innerHeight * devicePixelRatio
			});

			assureRequiredGLFeatures(context);
			
			var container = document.getElementById("container");
			context.domElement.style.height = "100%";
			context.domElement.style.width = "100%";
			container.appendChild(context.domElement);

			document.getElementById("resolution").value = gridResolution;
			document.getElementById("resolution").onchange = function () {
				window.location = "?res=" + this.value;
			};

			document.getElementById("newTerrain").href = "?res=" + gridResolution + "&seed=" + Math.floor(Math.random() * 10000);

			var waterMapUploaded = false;
			var satImageUploaded = false;

			var waterData;
			var satImage;
			var frictionData;
			var terrainData;
			var startNSteps;

			var waitOrInit = function () {
				if (terrainData && (!waterMapUploaded || waterData) && (!satImageUploaded || satImage)) {
					Simulation.init(waterData, terrainData, startNSteps, frictionData);
					start();
				}
			};

			document.getElementById("files").addEventListener("change", function (evt) {
				var files = evt.target.files; // FileList object

				// files is a FileList of File objects. List some properties.
				for (var i = 0, file; file = files[i]; i++) {
					console.log (file.name);

					var reader = new FileReader();

					if (files[i].name.indexOf("water") !== -1) {
						waterMapUploaded = true;
						startNSteps = parseInt(file.name.match(/water_t(\d+)\.tif/)[1], 10);
						reader.onload = function (e) {
							waterData = (new TIFFParser()).parseTIFF(e.target.result).data;
							waitOrInit();
						};
						reader.readAsArrayBuffer(file);
					} else if (file.name.indexOf("friction") !== -1) {
						reader.onload = function (e) {
							frictionData = (new TIFFParser()).parseTIFF(e.target.result).data;
						};
						reader.readAsArrayBuffer(file);
					} else if (file.name.indexOf("sat") !== -1) {
						satImageUploaded = true;
						reader.onload = function (e) {
							satImage = new Image();
							satImage.src = e.target.result;
							waitOrInit();
						};
						reader.readAsDataURL(file);
					} else if (file.name.indexOf("terrain") !== -1) {
						document.getElementById("scenarioName").value = file.name
								.replace("terrain", "")
								.replace(".tif", "")
								.replace(/_/g, " ")
								.replace(/\s+/g, " ")
								.trim();
						reader.onload = function (e) {
							var tiff = (new TIFFParser()).parseTIFF(e.target.result);
							gridResolution = tiff.width;
							terrainData = tiff.data;
							waitOrInit();
						};
						reader.readAsArrayBuffer(file);
					}
				}

			}, false);

			var seed = parseInt(getParameterByName("seed"));

			if (seed) {
				terrainData = new Float32Array(gridResolution * gridResolution);
				document.getElementById("scenarioName").value = "Random Scenario " + seed;

				var i = 0;

				var octaves = 16;
				noise.seed(seed);

				for (var y = 0; y < gridResolution; y++) {
					for (var x = 0; x < gridResolution; x++) {
						terrainData[i] = Math.max(0, terrain(x, y));
						i++;
					}
				}

				setTimeout(function () {
					Simulation.init(null, terrainData);
					start();
				}, 0);
			}

			var lastFrame = performance.now();
			var lastSecond = performance.now();
			var minFrame = 1000;
			var maxFrame = 0;
			var nFrames = 0;
			var nFramesTotal = 0;

			var start = function (render) {
				document.getElementById("load").style.display = "none";
				document.getElementById("run").style.display = "inline";

				Visualisation.init(satImage);

				UI.init({
					numbers: {
						"stepsPerFrame": Simulation.parameters,
						"sourceWaterHeight": Simulation.parameters,
						"sourceWaterVelocity": Simulation.parameters,
						"gravity": Simulation.parameters,
						"manningCoefficient": Simulation.parameters,
						"drainageAmount": Simulation.parameters
					},

					toggles: {
						"showWater": Visualisation.toggles,
						"showFloodDuration": Visualisation.toggles,
						"showMaxVelocity": Visualisation.toggles,
						"showMaxDepth": Visualisation.toggles
					},

					triggers: {
						"saveWater": function () {
							Visualisation.saveWaterNextFrame = true;
						},
						"saveTerrain": function () {
							var tiff = write16bitTiff(terrainData, gridResolution, gridResolution);
							var filename = document.getElementById("scenarioName").value
											.trim().replace(/\s/g, "_") + "_terrain.tif";
							saveContent(uint8ToBase64(tiff), filename);
						}
					}
				});

				var render = function () {
					window.requestAnimationFrame(render);

					var thisFrame = performance.now();
					var frameDuration = thisFrame - lastFrame;
					if (frameDuration > maxFrame) maxFrame = frameDuration;
					if (frameDuration < minFrame) minFrame = frameDuration;
					var avg = (thisFrame - lastSecond) / nFrames;
					lastFrame = thisFrame;

					if (thisFrame - lastSecond > 1000) {
						document.getElementById("frameDuration").innerText = "min " + minFrame.toFixed(1) + "ms - avg " +
						avg.toFixed(1) + "ms - max " + maxFrame.toFixed(1) + "ms";
						minFrame = 1000;
						maxFrame = 0;
						nFrames = 0;
						lastSecond = thisFrame;
					}

					nFrames ++;
					nFramesTotal ++;

					context.cache.clear();

					Simulation.update();
					Visualisation.render();
				};

				window.requestAnimationFrame(render);
			};
		</script>
	</body>
</html>
